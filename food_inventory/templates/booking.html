<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Calendar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <a href="/" class="nav-brand">üç≥ Food Room</a> |
            <a href="/recipes">Recipes</a> |
            <a href="/recbk">Recipe Book</a>
            {% if current_user.is_authenticated %}
                | <a href="/class_ingredients">Class Ingredients</a>
                | <a href="/booking">Booking Calendar</a>
                | <a href="/shoplist">Shopping List</a>
                {% if current_user.is_admin() %}
                    | <a href="/admin">Admin</a>
                {% endif %}
            {% endif %}
        </div>
        <div class="nav-right">
            {% if current_user.is_authenticated %}
                <span class="user-info">{{ current_user.name }}<span class="badge badge-{{ current_user.role }}">{{ current_user.role }}</span></span> | <a href="/logout" class="logout-link">Logout</a>
            {% else %}
                <a href="/login" class="login-link">Login</a>
            {% endif %}
        </div>
    </nav>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div style="margin:10px auto;padding:12px;background:#d4edda;border:1px solid #c3e6cb;color:#155724;border-radius:4px;max-width:1200px;">
                {% for message in messages %}
                    <div>{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="calendar-container">
        <h1>Booking Calendar</h1>
        
        <div class="export-options">
            <strong>Export Options:</strong>
            <a href="/booking/export/ical" class="google-cal-btn" download>üìÖ Download iCal (.ics)</a>
            <button onclick="syncGoogleCalendar()" class="google-cal-btn">üîÑ Add to Google Calendar</button>
            <p style="margin-top:10px;font-size:0.9em;color:#666;">
                Download the iCal file to import into Google Calendar, Outlook, or Apple Calendar
            </p>
        </div>

        <div class="legend">
            <strong>Legend:</strong>
            <span class="legend-item">
                <span class="legend-color" style="background:#d4edda;border:1px solid #c3e6cb;"></span>
                Class Booking
            </span>
            <span class="legend-item">
                <span class="legend-color" style="background:#fff3cd;border:1px solid #ffc107;"></span>
                Today
            </span>
        </div>

        <div class="calendar-header">
            <div class="calendar-nav">
                <button onclick="previousMonth()">‚Üê Previous</button>
                <button onclick="today()">Today</button>
                <button onclick="nextMonth()">Next ‚Üí</button>
            </div>
            <h2 id="current-month"></h2>
        </div>

        <div class="calendar-grid" id="calendar">
            <!-- Calendar will be generated by JavaScript -->
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeDetails()"></div>
    <div class="booking-details" id="booking-details">
        <span class="close-btn" onclick="closeDetails()">&times;</span>
        <div id="details-content"></div>
    </div>

    <script>
        let currentDate = new Date();
        const bookings = {{ bookings_json|safe }};

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            // Build calendar grid
            let html = '';
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month"><div class="day-number">${daysInPrevMonth - i}</div></div>`;
            }

            // Current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const dayBookings = bookings.filter(b => b.date === dateStr);
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''}">
                    <div class="day-number">${day}</div>`;
                
                dayBookings.forEach(booking => {
                    html += `<div class="booking-item" onclick="showDetails(${booking.id})">
                        ${booking.period}: ${booking.recipe_name}
                    </div>`;
                });
                
                html += '</div>';
            }

            // Next month days
            const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
            const remainingCells = totalCells - (firstDay + daysInMonth);
            for (let i = 1; i <= remainingCells; i++) {
                html += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
            }

            document.getElementById('calendar').innerHTML = html;
        }

        function showDetails(bookingId) {
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;

            // Extract period number from "Period 1" format
            const periodNum = parseInt(booking.period.split(' ')[1]);

            const content = `
                <h2>${booking.recipe_name}</h2>
                <p><strong>Date:</strong> ${booking.date}</p>
                <p><strong>Period:</strong> ${booking.period}</p>
                <p><strong>Staff:</strong> ${booking.staff_name}</p>
                <p><strong>Class:</strong> ${booking.class_code}</p>
                <p><strong>Servings:</strong> ${booking.servings}</p>
                <form method="POST" action="/class_ingredients" style="margin-top:15px;">
                    <input type="hidden" name="staff_code" value="${booking.staff_code}">
                    <input type="hidden" name="class_code" value="${booking.class_code}">
                    <input type="hidden" name="date_required" value="${booking.date}">
                    <input type="hidden" name="period" value="${periodNum}">
                    <button type="submit" class="google-cal-btn" style="cursor:pointer;">üìã View & Download Ingredients</button>
                </form>
            `;
            
            document.getElementById('details-content').innerHTML = content;
            document.getElementById('booking-details').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        function closeDetails() {
            document.getElementById('booking-details').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function today() {
            currentDate = new Date();
            renderCalendar();
        }

        function syncGoogleCalendar() {
            window.open('/booking/export/ical', '_blank');
            setTimeout(() => {
                alert('Download the .ics file and:\n\n1. Go to Google Calendar (calendar.google.com)\n2. Click the + next to "Other calendars"\n3. Select "Import"\n4. Choose the downloaded .ics file\n5. Select which calendar to add events to\n6. Click "Import"');
            }, 500);
        }

        // Initialize calendar
        renderCalendar();
    </script>
</body>
</html>
